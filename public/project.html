<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script defer src="/__/firebase/9.10.0/firebase-app-compat.js"></script>
    <script
      defer
      src="/__/firebase/9.10.0/firebase-database-compat.js"
    ></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
    <script defer src="js/database.js"></script>
    <title>Project</title>
  </head>
  <body>
    <header class="mdc-top-app-bar">
      <div class="mdc-top-app-bar__row">
        <section
          class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start"
        >
          <span id="project-name" class="mdc-top-app-bar__title">Project</span>
        </section>
      </div>
    </header>
    <main class="mdc-top-app-bar--fixed-adjust">
      <ul id="work-list" class="mdc-list"></ul>
      <button id="dialog-open-button" class="mdc-button mdc-button--raised">
        <span class="mdc-button__label">作業の追加</span>
      </button>
      <div class="mdc-dialog mdc-dialog--fullscreen">
        <div class="mdc-dialog__container">
          <div
            class="mdc-dialog__surface"
            role="dialog"
            aria-modal="true"
            aria-labelledby="dialog-title"
            aria-describedby="dialog-content"
          >
            <div class="mdc-dialog__header">
              <h2 class="mdc-dialog__title" id="dialog-title">作業の追加</h2>
              <button
                class="mdc-icon-button material-icons mdc-dialog__close"
                data-mdc-dialog-action="close"
              >
                close
              </button>
            </div>
            <div class="mdc-dialog__content" id="dialog-content">
              <label class="mdc-text-field mdc-text-field--outlined">
                <span class="mdc-notched-outline mdc-notched-outline--upgraded">
                  <span class="mdc-notched-outline__leading"></span>
                  <span class="mdc-notched-outline__notch">
                    <span class="mdc-floating-label" id="work-name-label"
                      >作業名</span
                    >
                  </span>
                  <span class="mdc-notched-outline__trailing"></span>
                </span>
                <input
                  id="work-name"
                  type="text"
                  class="mdc-text-field__input"
                  aria-labelledby="work-name-label"
                />
              </label>
            </div>
            <div class="mdc-dialog__actions">
              <button
                type="button"
                class="mdc-button mdc-dialog__button"
                data-mdc-dialog-action="close"
              >
                <div class="mdc-button__ripple"></div>
                <span class="mdc-button__label">キャンセル</span>
              </button>
              <button
                type="button"
                class="mdc-button mdc-dialog__button"
                data-mdc-dialog-action="ok"
              >
                <div class="mdc-button__ripple"></div>
                <span class="mdc-button__label">登録</span>
              </button>
            </div>
          </div>
        </div>
        <div class="mdc-dialog__scrim"></div>
      </div>
    </main>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // プロジェクト名はクエリパラメータ経由で受け取る
        const searchParams = new URLSearchParams(location.search)
        if (searchParams.has('projectName')) {
          // ヘッダー部分はプロジェクト名に合わせる
          const projectName = searchParams.get('projectName')
          const projectNameElem = document.getElementById('project-name')
          projectNameElem.textContent = projectName

          // 作業一覧はリストとして表示
          const workListElem = document.getElementById('work-list')
          getChildKeys(projectName).then((keys) => {
            if (keys.length === 0) {
              workListElem.insertAdjacentHTML(
                'beforeend',
                `<li class="mdc-list-item">
                  <span class="mdc-list-item__ripple"></span>
                  <span class="mdc-list-item__text">登録されている作業はありません</span>
                </li>`
              )
            } else {
              keys.forEach((key) => {
                workListElem.insertAdjacentHTML(
                  'beforeend',
                  `<li class="mdc-list-item">
                    <span class="mdc-list-item__ripple"></span>
                    <span class="mdc-list-item__text">${key}</span>
                  </li>`
                )
              })
            }
          })
        } else {
          console.log('query not found')
        }
        const MDCDialog = mdc.dialog.MDCDialog
        const dialog = new MDCDialog(document.querySelector('.mdc-dialog'))
        const dialogOpenButton = document.getElementById('dialog-open-button')
        dialogOpenButton.addEventListener('click', () => {
          if (!dialog.isOpen) {
            dialog.open()
          }
        })

        dialog.listen('MDCDialog:closing', (action) => {
          const actionDetail = action.detail.action
          const workName = document.getElementById('work-name').value
          console.log(workName)
          const data = {
            [workName]: {
              material: '',
              movie: '',
            },
          }
          const searchParams = new URLSearchParams(location.search)
          if (searchParams.has('projectName')) {
            const projectName = searchParams.get('projectName')
            updateData(`${projectName}`, data)
          }
        })
      })
    </script>
  </body>
</html>
